# Reverse Osmosis Simulation

# ---[Variables]-----------------------------------------------------------
# Geometric
variable ZL equal 13.0  # Start of the liquid region.
variable ZH equal 65.0  # End of the liquid region.
# Dynamics  [TODO: Determine a suitable velosity for piston.]
variable TS equal 0.1  # Time Step in femto-seconds.
variable PV equal 0.01  # Velocity of the piston movement.
variable dx equal (${ZH}-${ZL})*3/4  # Required piston displacement.
variable TTS equal floor(${dx}/(${PV}*${TS}))  # Total Time Step.
# Thermodynamic
variable T equal 298.15  # Room tempreture.
variable P equal 1.0  # Pressure.
variable TD equal 100.0  # Temperature Damping Rate for NPT and NVT fixes.
variable PD equal 1000.0  # Pressure Damping Rate for NPT fix.
# Optimization
variable TE equal 1.0e-8  # Minimizatin Total Energy.
variable TF equal 1.0e-10  # Minimizatin Total Force.
variable MaxIter equal 1000  # Minimizatin Maximum Iteration.
variable MaxEval equal 10000  # Minimizatin Maximum Evaluation.

# ---[Initialization]------------------------------------------------------

log        log/log.ro.lammps
dimension  3
units      real
boundary   p p p
atom_style full
# System Definition
read_data  system/system.data
fix WALL all wall/lj126 zlo EDGE 1.0 1.0 2.5 pbc yes
neigh_modify one 10000

# ---[Regions/Groups]------------------------------------------------------

region piston block  INF INF  INF INF  ${ZH} INF
region liquid block  INF INF  INF INF  ${ZL} ${ZH}
region bottom block  INF INF  INF INF  INF   ${ZL}

group bottom region  bottom
group piston region  piston
group liquid region  liquid

group C     type  1   
group H     type  4   
group N     type  5   
group O     type  7   
group Ti    type  8   
group water type  7 4
group Ions  type  6 3 2
group mxene type  8 5 1

# ---[Interactions]-[water model]------------------------------------------
pair_style   lj/cut/coul/long 10
bond_style   harmonic
angle_style  harmonic
# TIP3P water model
pair_coeff   7 4  0.1553 3.166  # H-O
bond_coeff   1    450.0  0.9572  # H-O
angle_coeff  5    55.0   104.52  # H-O
fix WATER water shake 1e-4 20 0 b 1 a 1
# Other interactions [TODO: Insert other interactions coeffs]
pair_coeff   * *  0.1553 3.166
angle_coeff  *    1.0    0.0
# Electrodynamics (long range interactions)
kspace_style ewald 1e-4

# ---[Settings]------------------------------------------------------------
# Room temperature
velocity all create  $T 49284  dist gaussian  rot yes
# Immovable parts
fix MEMBRANE bottom  setforce  0.0  0.0  0.0
fix PISTON   piston  setforce  0.0  0.0  0.0
# Calculations
thermo       100
timestep     ${TS}
thermo_style multi
# Visualization
dump        1 all      xyz 100 visual/dump.ro.xyz
dump_modify 1 element  C Ca Cl HW N Na OW Ti

# ---[Thermodynamic Equilibrium]-------------------------------------------
# Microcanonical ensemble (NVE)
fix      NVE  all  nve
minimize ${TE} ${TF} ${MaxIter} ${MaxEval}
unfix    NVE
# Canonical ensemble (NVT)
fix      NVT  all  nvt  temp $T $T ${TD}
minimize ${TE} ${TF} ${MaxIter} ${MaxEval}
unfix    NVT
# Isobaric-Isothermal ensemble (NPT)
fix      NPT  all  npt  temp $T $T ${TD}  iso $P $P ${PD}
minimize ${TE} ${TF} ${MaxIter} ${MaxEval}
unfix    NPT

# ---[Simulation run]------------------------------------------------------

unfix PISTON
unfix MEMBRANE

fix   NVE      all     nve
fix   PISTON   piston  move linear  0.0  0.0 -${PV}
fix   MEMBRANE bottom  move linear  0.0  0.0 0.0
run   ${TTS}

# ---[Finalization]--------------------------------------------------------
# [TODO: Uncomment to use.]
# write_restart ro.rest
# write_data    ro.data
